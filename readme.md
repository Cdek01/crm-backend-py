# CRM API на FastAPI с конструктором сущностей и фоновыми задачами

Это бэкенд для гибкой CRM-системы, построенный на FastAPI.

## Ключевые возможности

*   **Современный API:** Построен на FastAPI с асинхронной обработкой запросов.
*   **Многопользовательская архитектура (Multi-tenancy):** Данные каждой компании-клиента полностью изолированы.
*   **Конструктор таблиц (EAV):** Позволяет пользователям создавать собственные сущности ("таблицы") с настраиваемыми полями.
*   **Фоновые задачи:** Интеграция с Celery и Redis для выполнения длительных операций (например, SMS-рассылок) без блокировки API.
*   **Аутентификация:** Безопасность на основе JWT-токенов.
*   **Управление базой данных:** Используется SQLAlchemy ORM и система миграций Alembic.

---

## 1. Системные требования (Prerequisites)

Перед началом установки убедитесь, что на вашем сервере (или локальной машине) установлены:

*   Python 3.10+
*   Git
*   Redis (Сервер баз данных ключ-значение)

```bash
# Пример установки для Debian/Ubuntu
sudo apt update
sudo apt install python3-venv python3-pip git redis-server -y

# Включаем автозапуск Redis
sudo systemctl enable --now redis-server


2. Установка и настройка
Шаг 1: Клонировать репозиторий
Generated bash
git clone https://github.com/Cdek01/crm-backend-py.git
cd crm-backend-py

Bash
Шаг 2: Создать и активировать виртуальное окружение
Generated bash
python3 -m venv venv
source venv/bin/activate


Bash
Шаг 3: Установить зависимости Python
Generated bash
pip install -r requirements.txt

Bash
Шаг 4: Настроить переменные окружения
Создайте файл .env в корне проекта, скопировав пример.
Generated bash
cp .env.example .env

Bash
Теперь откройте файл .env и заполните его своими значениями:
Generated dotenv
# .env

# Адрес базы данных. Для SQLite (локальный файл)
DATABASE_URL="sqlite:///./crm.db"

# Секретный ключ для JWT. Сгенерируйте сложный ключ.
# Можно сгенерировать командой: openssl rand -hex 32
SECRET_KEY="ВАШ_СУПЕР_СЕКРЕТНЫЙ_КЛЮЧ"
ALGORITHM="HS256"
ACCESS_TOKEN_EXPIRE_MINUTES=30

# Ключи для API Wappi.pro
API_KEY_WAPPI="ВАШ_API_КЛЮЧ_WAPPI"
PROFILE_ID_WAPPI="ВАШ_ID_ПРОФИЛЯ_WAPPI"

# Адрес Redis для Celery
CELERY_BROKER_URL="redis://localhost:6379/0"
CELERY_RESULT_BACKEND="redis://localhost:6379/0"

Dotenv
Шаг 5: Применить миграции базы данных
Эта команда создаст все необходимые таблицы в базе данных в соответствии с моделями.
Generated bash
alembic upgrade head

Bash
3. Запуск приложения для разработки
Для работы приложения необходимо запустить 2 постоянно работающих процесса: веб-сервер FastAPI и воркер Celery. Redis должен быть уже запущен как системный сервис.
Для удобного управления процессами в одном окне терминала рекомендуется использовать tmux.
Шаг 1: Установить tmux (если не установлен)
Generated bash
sudo apt install tmux

Bash
Шаг 2: Запустить сессию tmux
Мы создадим именованную сессию crm для удобства.
Generated bash
tmux new -s crm

Bash
Шаг 3: Запустить веб-сервер FastAPI (в первой панели)
Активируйте виртуальное окружение и запустите Uvicorn.
Generated bash
source venv/bin/activate
uvicorn main:app --host 0.0.0.0 --port 8005 --reload

Bash
Флаг --reload удобен для разработки, так как сервер будет автоматически перезапускаться при изменении кода.
Шаг 4: Запустить воркер Celery (во второй панели)
Разделите экран на две панели: нажмите Ctrl+b, затем %.
Вы окажетесь в новой панели справа. Активируйте в ней окружение и запустите воркер:
Generated bash
source venv/bin/activate
celery -A celery_worker.celery_app worker --loglevel=info

Bash
Готово! Теперь у вас в одном окне работают оба компонента приложения.
Для переключения между панелями используйте Ctrl+b + стрелки.
Чтобы "свернуть" сессию и оставить ее работать в фоне, нажмите Ctrl+b + d.
Чтобы вернуться в запущенную сессию, введите tmux attach -t crm.
4. Тестирование
После запуска всех компонентов вы можете проверить работу API.
Интерактивная документация (Swagger UI): Откройте в браузере http://89.111.169.47:8005/docs.
Автоматические тесты: В проекте есть скрипты для комплексного тестирования эндпоинтов. Запустите их из корня проекта:
Generated bash
# Активируйте окружение, если вышли из него
source venv/bin/activate

# Запуск основного тестового скрипта
python zapr.py

# Запуск скрипта для проверки рассылок
python zap_wap.py





Ваш рабочий процесс по настройке доступа будет таким:
(Однократно) Наполнение разрешений: Вы должны один раз наполнить таблицу permissions всеми возможными правами (leads:view, leads:edit и т.д.). Это можно сделать SQL-скриптом или Python-скриптом. Без этого список разрешений будет пуст.
Создание Роли:
Зайдите в раздел "Роли".
Нажмите "Create".
Введите имя роли (например, "Менеджер по продажам").
Выберите клиента (tenant), которому будет принадлежать эта роль.
В поле "Permissions" вы увидите список всех доступных разрешений. Выберите нужные (например, зажмите Ctrl и кликните на leads:view, leads:create, individuals:view).
Нажмите "Save".
Назначение Роли Пользователю:
Зайдите в раздел "Пользователи".
Выберите пользователя, которому хотите дать доступ.
В поле "Roles" вы увидите список всех созданных ролей. Выберите нужную роль ("Менеджер по продажам").
Нажмите "Save".
Всё! Теперь этот пользователь, войдя в систему, сможет просматривать и создавать лиды, но не сможет их редактировать или удалять, потому что у него есть только те права, которые вы определили для его роли.
Шаг 3: Запуск скрипта
Теперь, когда у вас есть этот файл, вы можете запустить его из терминала.
Убедитесь, что ваша база данных создана и доступна (скрипт использует те же настройки из .env, что и основное приложение).
Активируйте ваше виртуальное окружение (venv\Scripts\activate).
Выполните команду:
code
Bash
python seed_permissions.py