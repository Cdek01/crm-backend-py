# test_sip_connection.py
import requests
import time


class SIPConnectionTester:
    def __init__(self, base_url, api_token):
        self.base_url = base_url.rstrip('/')
        self.headers = {'X-MPBX-API-AUTH-TOKEN': api_token}

    def make_test_call(self):
        """–¢–µ—Å—Ç–æ–≤—ã–π –∑–≤–æ–Ω–æ–∫ —Å –ø–æ–¥—Ä–æ–±–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–æ–π"""
        pattern = "SIP0343PU049QK@ip.beeline.ru"
        test_number = "+79952116323"

        print("üéØ –¢–ï–°–¢–û–í–´–ô –ó–í–û–ù–û–ö –° –î–ò–ê–ì–ù–û–°–¢–ò–ö–û–ô")
        print("=" * 50)

        url = f"{self.base_url}/v2/abonents/{pattern}/call"
        params = {'phoneNumber': test_number}

        print(f"üìû –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞...")
        print(f"   –ê–±–æ–Ω–µ–Ω—Ç: {pattern}")
        print(f"   –ù–æ–º–µ—Ä: {test_number}")

        try:
            response = requests.post(url, headers=self.headers, params=params, timeout=30)

            if response.status_code == 200:
                result = response.json()
                call_id = result.get('callId')

                print(f"‚úÖ –ó–í–û–ù–û–ö –£–°–ü–ï–®–ù–û –ò–ù–ò–¶–ò–ò–†–û–í–ê–ù! {result}")
                print(f"   Call ID: {call_id}")

                # –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
                self.monitor_call(call_id)

            else:
                print(f"‚ùå –û—à–∏–±–∫–∞ API: {response.status_code}")
                print(f"   –û—Ç–≤–µ—Ç: {response.text}")

        except Exception as e:
            print(f"‚ùå –û—à–∏–±–∫–∞ —Å–µ—Ç–∏: {e}")

    def monitor_call(self, call_id):
        """–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Å—Ç–∞—Ç—É—Å–∞ –∑–≤–æ–Ω–∫–∞"""
        print(f"\nüìä –ú–û–ù–ò–¢–û–†–ò–ù–ì –ó–í–û–ù–ö–ê {call_id}:")
        print("üí° –°–õ–£–®–ê–ô–¢–ï SIP –ö–õ–ò–ï–ù–¢ - –û–ù –î–û–õ–ñ–ï–ù –ó–í–û–ù–ò–¢–¨!")

        for i in range(1, 7):  # 30 —Å–µ–∫—É–Ω–¥ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
            print(f"   {i}/6 - –ü—Ä–æ—à–ª–æ {i * 5} —Å–µ–∫—É–Ω–¥...")

            if i == 1:
                print("   üéØ SIP –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –∑–∞–∑–≤–æ–Ω–∏—Ç—å –≤ —Ç–µ—á–µ–Ω–∏–µ 10-20 —Å–µ–∫")
            elif i == 3:
                print("   üîç –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Å—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –≤ SIP –∫–ª–∏–µ–Ω—Ç–µ")
            elif i == 5:
                print("   ‚ö†Ô∏è  –ï—Å–ª–∏ –Ω–µ –∑–≤–æ–Ω–∏—Ç - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏ –ø–∞—Ä–æ–ª—å")

            time.sleep(5)

        print(f"\nüìù –ò–¢–û–ì–ò –¢–ï–°–¢–ê:")
        print("‚úÖ API –æ—Ç—Ä–∞–±–æ—Ç–∞–ª –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
        print("üìû –ó–≤–æ–Ω–æ–∫ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ Cloud PBX")
        print("üîä SIP –∫–ª–∏–µ–Ω—Ç –¥–æ–ª–∂–µ–Ω –±—ã–ª –ø–æ–ª—É—á–∏—Ç—å –≤—ã–∑–æ–≤")


def main():
    BASE_URL = "https://cloudpbx.beeline.ru/apis/portal"
    API_TOKEN = "f0744ced-44e3-4d88-9ec7-f7823d83d634"

    tester = SIPConnectionTester(BASE_URL, API_TOKEN)

    print("=== –¢–ï–°–¢ –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø SIP –ö–õ–ò–ï–ù–¢–ê ===")
    print("\nüéØ –ü–ï–†–ï–î –¢–ï–°–¢–û–ú –£–ë–ï–î–ò–¢–ï–°–¨, –ß–¢–û:")
    print("   1. SIP –∫–ª–∏–µ–Ω—Ç –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏")
    print("   2. –°—Ç–∞—Ç—É—Å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ 'Registered' –∏–ª–∏ 'Connected'")
    print("   3. –ü–∞—Ä–æ–ª—å –≤–≤–µ–¥–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ")
    print("   4. –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç")

    input("\n–ù–∞–∂–º–∏—Ç–µ Enter –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ç–µ—Å—Ç–∞...")

    tester.make_test_call()

    print("\n" + "=" * 60)
    print("üí° –ï–°–õ–ò –¢–ï–°–¢ –ù–ï –£–î–ê–õ–°–Ø - –ü–†–û–í–ï–†–¨–¢–ï:")
    print("=" * 60)
    print("""
1. üîê –ü–ê–†–û–õ–¨:
   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–∞—Ä–æ–ª—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π
   ‚Ä¢ –ü–∞—Ä–æ–ª—å —á—É–≤—Å—Ç–≤–∏—Ç–µ–ª–µ–Ω –∫ —Ä–µ–≥–∏—Å—Ç—Ä—É

2. üì° –°–ï–¢–¨:
   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç-–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
   ‚Ä¢ –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –ø–æ—Ä—Ç 5060 –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è

3. ‚öôÔ∏è –ù–ê–°–¢–†–û–ô–ö–ò:
   ‚Ä¢ –ü–µ—Ä–µ–ø—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã SIP
   ‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ TCP –≤–º–µ—Å—Ç–æ UDP

4. üåê –í–ï–ë-–ö–õ–ò–ï–ù–¢:
   ‚Ä¢ –î–ª—è –±—ã—Å—Ç—Ä–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–µ–±-–∫–ª–∏–µ–Ω—Ç –≤ –õ–ö
   ‚Ä¢ –ù–µ —Ç—Ä–µ–±—É–µ—Ç —Å–ª–æ–∂–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
    """)


if __name__ == "__main__":
    main()